var f=Object.assign;(function(){"use strict";var re=tinymce.util.Tools.resolve("tinymce.PluginManager");const $=a=>e=>(r=>{const t=typeof r;return r===null?"null":t==="object"&&Array.isArray(r)?"array":t==="object"&&(s=l=r,(i=String).prototype.isPrototypeOf(s)||((m=l.constructor)===null||m===void 0?void 0:m.name)===i.name)?"string":t;var s,l,i,m})(e)===a,N=$("string"),R=$("object"),ae=$("array"),j=a=>!(e=>e==null)(a);class g{constructor(e,r){this.tag=e,this.value=r}static some(e){return new g(!0,e)}static none(){return g.singletonNone}fold(e,r){return this.tag?r(this.value):e()}isSome(){return this.tag}isNone(){return!this.tag}map(e){return this.tag?g.some(e(this.value)):g.none()}bind(e){return this.tag?e(this.value):g.none()}exists(e){return this.tag&&e(this.value)}forall(e){return!this.tag||e(this.value)}filter(e){return!this.tag||e(this.value)?this:g.none()}getOr(e){return this.tag?this.value:e}or(e){return this.tag?this:e}getOrThunk(e){return this.tag?this.value:e()}orThunk(e){return this.tag?this:e()}getOrDie(e){if(this.tag)return this.value;throw new Error(e!=null?e:"Called getOrDie on None")}static from(e){return j(e)?g.some(e):g.none()}getOrNull(){return this.tag?this.value:null}getOrUndefined(){return this.value}each(e){this.tag&&e(this.value)}toArray(){return this.tag?[this.value]:[]}toString(){return this.tag?`some(${this.value})`:"none()"}}g.singletonNone=new g(!1);const oe=Array.prototype.push,x=(a,e)=>{for(let r=0,t=a.length;r<t;r++)e(a[r],r)},se=a=>{const e=[];for(let r=0,t=a.length;r<t;++r){if(!ae(a[r]))throw new Error("Arr.flatten item "+r+" was not an array, input: "+a);oe.apply(e,a[r])}return e},ie=Object.keys,ne=Object.hasOwnProperty,w=(a,e)=>z(a,e)?g.from(a[e]):g.none(),z=(a,e)=>ne.call(a,e),y=a=>e=>e.options.get(a),ce=y("audio_template_callback"),le=y("video_template_callback"),me=y("iframe_template_callback"),ue=y("media_live_embeds"),de=y("media_filter_html"),he=y("media_url_resolver"),pe=y("media_alt_source"),ge=y("media_poster"),be=y("media_dimensions");var O=tinymce.util.Tools.resolve("tinymce.util.Tools"),U=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),P=tinymce.util.Tools.resolve("tinymce.html.DomParser");const we=U.DOM,E=a=>a.replace(/px$/,""),ve=a=>{const e=a.attr("style"),r=e?we.parseStyle(e):{};return{type:"ephox-embed-iri",source:a.attr("data-ephox-embed-iri"),altsource:"",poster:"",width:w(r,"max-width").map(E).getOr(""),height:w(r,"max-height").map(E).getOr("")}},S=(a,e)=>{let r={};for(let t=P({validate:!1,forced_root_block:!1},e).parse(a);t;t=t.walk())if(t.type===1){const s=t.name;if(t.attr("data-ephox-embed-iri")){r=ve(t);break}r.source||s!=="param"||(r.source=t.attr("movie")),s!=="iframe"&&s!=="object"&&s!=="embed"&&s!=="video"&&s!=="audio"||(r.type||(r.type=s),r=O.extend(t.attributes.map,r)),s==="script"&&(r={type:"script",source:t.attr("src")}),s==="source"&&(r.source?r.altsource||(r.altsource=t.attr("src")):r.source=t.attr("src")),s!=="img"||r.poster||(r.poster=t.attr("src"))}return r.source=r.source||r.src||"",r.altsource=r.altsource||"",r.poster=r.poster||"",r},L=a=>{var e;const r=(e=a.toLowerCase().split(".").pop())!==null&&e!==void 0?e:"";return w({mp3:"audio/mpeg",m4a:"audio/x-m4a",wav:"audio/wav",mp4:"video/mp4",webm:"video/webm",ogg:"video/ogg",swf:"application/x-shockwave-flash"},r).getOr("")};var _=tinymce.util.Tools.resolve("tinymce.html.Node"),I=tinymce.util.Tools.resolve("tinymce.html.Serializer");const M=(a,e={})=>P(f({forced_root_block:!1,validate:!1,allow_conditional_comments:!0},e),a),B=U.DOM,G=a=>/^[0-9.]+$/.test(a)?a+"px":a,fe=(a,e)=>{const r=e.attr("style"),t=r?B.parseStyle(r):{};j(a.width)&&(t["max-width"]=G(a.width)),j(a.height)&&(t["max-height"]=G(a.height)),e.attr("style",B.serializeStyle(t))},k=["source","altsource"],F=(a,e,r,t)=>{let s=0,l=0;const i=M(t);i.addNodeFilter("source",o=>s=o.length);const m=i.parse(a);for(let o=m;o;o=o.walk())if(o.type===1){const c=o.name;if(o.attr("data-ephox-embed-iri")){fe(e,o);break}switch(c){case"video":case"object":case"embed":case"img":case"iframe":e.height!==void 0&&e.width!==void 0&&(o.attr("width",e.width),o.attr("height",e.height))}if(r)switch(c){case"video":o.attr("poster",e.poster),o.attr("src",null);for(let n=s;n<2;n++)if(e[k[n]]){const u=new _("source",1);u.attr("src",e[k[n]]),u.attr("type",e[k[n]+"mime"]||null),o.append(u)}break;case"iframe":o.attr("src",e.source);break;case"object":const d=o.getAll("img").length>0;if(e.poster&&!d){o.attr("src",e.poster);const n=new _("img",1);n.attr("src",e.poster),n.attr("width",e.width),n.attr("height",e.height),o.append(n)}break;case"source":if(l<2&&(o.attr("src",e[k[l]]),o.attr("type",e[k[l]+"mime"]||null),!e[k[l]])){o.remove();continue}l++;break;case"img":e.poster||o.remove()}}return I({},t).serialize(m)},ye=[{regex:/youtu\.be\/([\w\-_\?&=.]+)/i,type:"iframe",w:560,h:314,url:"www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/youtube\.com(.+)v=([^&]+)(&([a-z0-9&=\-_]+))?/i,type:"iframe",w:560,h:314,url:"www.youtube.com/embed/$2?$4",allowFullscreen:!0},{regex:/youtube.com\/embed\/([a-z0-9\?&=\-_]+)/i,type:"iframe",w:560,h:314,url:"www.youtube.com/embed/$1",allowFullscreen:!0},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc",allowFullscreen:!0},{regex:/vimeo\.com\/(.*)\/([0-9]+)/,type:"iframe",w:425,h:350,url:"player.vimeo.com/video/$2?title=0&amp;byline=0",allowFullscreen:!0},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'maps.google.com/maps/ms?msid=$2&output=embed"',allowFullscreen:!1},{regex:/dailymotion\.com\/video\/([^_]+)/,type:"iframe",w:480,h:270,url:"www.dailymotion.com/embed/video/$1",allowFullscreen:!0},{regex:/dai\.ly\/([^_]+)/,type:"iframe",w:480,h:270,url:"www.dailymotion.com/embed/video/$1",allowFullscreen:!0}],xe=(a,e)=>{const r=(l=>{const i=l.match(/^(https?:\/\/|www\.)(.+)$/i);return i&&i.length>1?i[1]==="www."?"https://":i[1]:"https://"})(e),t=a.regex.exec(e);let s=r+a.url;if(j(t))for(let l=0;l<t.length;l++)s=s.replace("$"+l,()=>t[l]?t[l]:"");return s.replace(/\?$/,"")},W=(a,e)=>{var r;const t=O.extend({},e);if(!t.source&&(O.extend(t,S((r=t.embed)!==null&&r!==void 0?r:"",a.schema)),!t.source))return"";t.altsource||(t.altsource=""),t.poster||(t.poster=""),t.source=a.convertURL(t.source,"source"),t.altsource=a.convertURL(t.altsource,"source"),t.sourcemime=L(t.source),t.altsourcemime=L(t.altsource),t.poster=a.convertURL(t.poster,"poster");const s=(l=>{const i=ye.filter(m=>m.regex.test(l));return i.length>0?O.extend({},i[0],{url:xe(i[0],l)}):null})(t.source);if(s&&(t.source=s.url,t.type=s.type,t.allowfullscreen=s.allowFullscreen,t.width=t.width||String(s.w),t.height=t.height||String(s.h)),t.embed)return F(t.embed,t,!0,a.schema);{const l=ce(a),i=le(a),m=me(a);return t.width=t.width||"300",t.height=t.height||"150",O.each(t,(o,c)=>{t[c]=a.dom.encode(""+o)}),t.type==="iframe"?((o,c)=>{if(c)return c(o);{const d=o.allowfullscreen?' allowFullscreen="1"':"";return'<iframe src="'+o.source+'" width="'+o.width+'" height="'+o.height+'"'+d+"></iframe>"}})(t,m):t.sourcemime==="application/x-shockwave-flash"?(o=>{let c='<object data="'+o.source+'" width="'+o.width+'" height="'+o.height+'" type="application/x-shockwave-flash">';return o.poster&&(c+='<img src="'+o.poster+'" width="'+o.width+'" height="'+o.height+'" />'),c+="</object>",c})(t):t.sourcemime.indexOf("audio")!==-1?((o,c)=>c?c(o):'<audio controls="controls" src="'+o.source+'">'+(o.altsource?`
<source src="`+o.altsource+'"'+(o.altsourcemime?' type="'+o.altsourcemime+'"':"")+` />
`:"")+"</audio>")(t,l):t.type==="script"?(o=>'<script src="'+o.source+'"></script>')(t):((o,c)=>c?c(o):'<video width="'+o.width+'" height="'+o.height+'"'+(o.poster?' poster="'+o.poster+'"':"")+` controls="controls">
<source src="`+o.source+'"'+(o.sourcemime?' type="'+o.sourcemime+'"':"")+` />
`+(o.altsource?'<source src="'+o.altsource+'"'+(o.altsourcemime?' type="'+o.altsourcemime+'"':"")+` />
`:"")+"</video>")(t,i)}},q=a=>a.hasAttribute("data-mce-object")||a.hasAttribute("data-ephox-embed-iri"),C={},H=a=>e=>W(a,e),J=(a,e)=>{const r=he(a);return r?((t,s,l)=>new Promise((i,m)=>{const o=c=>(c.html&&(C[t.source]=c),i({url:t.source,html:c.html?c.html:s(t)}));C[t.source]?o(C[t.source]):l({url:t.source},o,m)}))(e,H(a),r):((t,s)=>Promise.resolve({html:s(t),url:t.source}))(e,H(a))},_e=(a,e)=>{const r={};return w(a,"dimensions").each(t=>{x(["width","height"],s=>{w(e,s).orThunk(()=>w(t,s)).each(l=>r[s]=l)})}),r},A=(a,e)=>{const r=e&&e!=="dimensions"?((s,l)=>w(l,s).bind(i=>w(i,"meta")))(e,a).getOr({}):{},t=((s,l,i)=>m=>{const o=()=>w(s,m),c=()=>w(l,m),d=n=>w(n,"value").bind(u=>u.length>0?g.some(u):g.none());return{[m]:(m===i?o().bind(n=>R(n)?d(n).orThunk(c):c().orThunk(()=>g.from(n))):c().orThunk(()=>o().bind(n=>R(n)?d(n):g.from(n)))).getOr("")}})(a,r,e);return f(f(f(f(f({},t("source")),t("altsource")),t("poster")),t("embed")),_e(a,r))},D=a=>{const e=f(f({},a),{source:{value:w(a,"source").getOr("")},altsource:{value:w(a,"altsource").getOr("")},poster:{value:w(a,"poster").getOr("")}});return x(["width","height"],r=>{w(a,r).each(t=>{const s=e.dimensions||{};s[r]=t,e.dimensions=s})}),e},K=a=>e=>{const r=e&&e.msg?"Media embed handler error: "+e.msg:"Media embed handler threw unknown error.";a.notificationManager.open({type:"error",text:r})},Q=(a,e)=>r=>{if(N(r.url)&&r.url.trim().length>0){const t=r.html,s=f(f({},S(t,e.schema)),{source:r.url,embed:t});a.setData(D(s))}},V=(a,e)=>{const r=a.dom.select("*[data-mce-object]");a.insertContent(e),((t,s)=>{const l=t.dom.select("*[data-mce-object]");for(let i=0;i<s.length;i++)for(let m=l.length-1;m>=0;m--)s[i]===l[m]&&l.splice(m,1);t.selection.select(l[0])})(a,r),a.nodeChanged()},X=a=>{const e=(n=>{const u=n.selection.getNode(),h=q(u)?n.serializer.serialize(u,{selection:!0}):"";return f({embed:h},S(h,n.schema))})(a),r=(n=>{let u=n;return{get:()=>u,set:h=>{u=h}}})(e),t=D(e),s=be(a)?[{type:"sizeinput",name:"dimensions",label:"Constrain proportions",constrain:!0}]:[],l={title:"General",name:"general",items:se([[{name:"source",type:"urlinput",filetype:"media",label:"Source"}],s])},i=[];pe(a)&&i.push({name:"altsource",type:"urlinput",filetype:"media",label:"Alternative source URL"}),ge(a)&&i.push({name:"poster",type:"urlinput",filetype:"image",label:"Media poster (Image URL)"});const m={title:"Advanced",name:"advanced",items:i},o=[l,{title:"Embed",items:[{type:"textarea",name:"embed",label:"Paste your embed code below:"}]}];i.length>0&&o.push(m);const c={type:"tabpanel",tabs:o},d=a.windowManager.open({title:"Insert/Edit Media",size:"normal",body:c,buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],onSubmit:n=>{const u=A(n.getData());((h,p,b)=>{var v,T;p.embed=F((v=p.embed)!==null&&v!==void 0?v:"",p,!1,b.schema),p.embed&&(h.source===p.source||(T=p.source,z(C,T)))?V(b,p.embed):J(b,p).then(De=>{V(b,De.html)}).catch(K(b))})(r.get(),u,a),n.close()},onChange:(n,u)=>{switch(u.name){case"source":((h,p)=>{const b=A(p.getData(),"source");h.source!==b.source&&(Q(d,a)({url:b.source,html:""}),J(a,b).then(Q(d,a)).catch(K(a)))})(r.get(),n);break;case"embed":(h=>{var p;const b=A(h.getData()),v=S((p=b.embed)!==null&&p!==void 0?p:"",a.schema);h.setData(D(v))})(n);break;case"dimensions":case"altsource":case"poster":((h,p)=>{const b=A(h.getData(),p),v=W(a,b);h.setData(D(f(f({},b),{embed:v})))})(n,u.name)}r.set(A(n.getData()))},initialData:t})};var je=tinymce.util.Tools.resolve("tinymce.Env");const ke=a=>{const e=a.name;return e==="iframe"||e==="video"||e==="audio"},Y=(a,e,r,t=null)=>{const s=a.attr(r);return j(s)?s:z(e,r)?null:t},Z=(a,e,r)=>{const t=e.name==="img"||a.name==="video",s=t?"300":null,l=a.name==="audio"?"30":"150",i=t?l:null;e.attr({width:Y(a,r,"width",s),height:Y(a,r,"height",i)})},Oe=(a,e)=>{const r=e.name,t=new _("img",1);return ee(a,e,t),Z(e,t,{}),t.attr({style:e.attr("style"),src:je.transparentSrc,"data-mce-object":r,class:"mce-object mce-object-"+r}),t},Ae=(a,e)=>{var r;const t=e.name,s=new _("span",1);s.attr({contentEditable:"false",style:e.attr("style"),"data-mce-object":t,class:"mce-preview-object mce-object-"+t}),ee(a,e,s);const l=a.dom.parseStyle((r=e.attr("style"))!==null&&r!==void 0?r:""),i=new _(t,1);if(Z(e,i,l),i.attr({src:e.attr("src"),style:e.attr("style"),class:e.attr("class")}),t==="iframe")i.attr({allowfullscreen:e.attr("allowfullscreen"),frameborder:"0"});else{x(["controls","crossorigin","currentTime","loop","muted","poster","preload"],c=>{i.attr(c,e.attr(c))});const o=s.attr("data-mce-html");j(o)&&((c,d,n,u)=>{const h=M(c.schema).parse(u,{context:d});for(;h.firstChild;)n.append(h.firstChild)})(a,t,i,unescape(o))}const m=new _("span",1);return m.attr("class","mce-shim"),s.append(i),s.append(m),s},ee=(a,e,r)=>{var t;const s=(t=e.attributes)!==null&&t!==void 0?t:[];let l=s.length;for(;l--;){const n=s[l].name;let u=s[l].value;n==="width"||n==="height"||n==="style"||(m="data-mce-",(i=n).length>=m.length&&i.substr(0,0+m.length)===m)||(n!=="data"&&n!=="src"||(u=a.convertURL(u,n)),r.attr("data-mce-p-"+n,u))}var i,m;const o=I({inner:!0},a.schema),c=new _("div",1);x(e.children(),n=>c.append(n));const d=o.serialize(c);d&&(r.attr("data-mce-html",escape(d)),r.empty())},Se=a=>{const e=a.attr("class");return N(e)&&/\btiny-pageembed\b/.test(e)},te=a=>{let e=a;for(;e=e.parent;)if(e.attr("data-ephox-embed-iri")||Se(e))return!0;return!1},Ce=(a,e,r)=>{const t=de(a);return M(a.schema,{validate:t}).parse(r,{context:e})};re.add("media",a=>((e=>{const r=e.options.register;r("audio_template_callback",{processor:"function"}),r("video_template_callback",{processor:"function"}),r("iframe_template_callback",{processor:"function"}),r("media_live_embeds",{processor:"boolean",default:!0}),r("media_filter_html",{processor:"boolean",default:!0}),r("media_url_resolver",{processor:"function"}),r("media_alt_source",{processor:"boolean",default:!0}),r("media_poster",{processor:"boolean",default:!0}),r("media_dimensions",{processor:"boolean",default:!0})})(a),(e=>{e.addCommand("mceMedia",()=>{X(e)})})(a),(e=>{const r=()=>e.execCommand("mceMedia");e.ui.registry.addToggleButton("media",{tooltip:"Insert/edit media",icon:"embed",onAction:r,onSetup:t=>{const s=e.selection;return t.setActive(q(s.getNode())),s.selectorChangedWithUnbind("img[data-mce-object],span[data-mce-object],div[data-ephox-embed-iri]",t.setActive).unbind}}),e.ui.registry.addMenuItem("media",{icon:"embed",text:"Media...",onAction:r})})(a),(e=>{e.on("ResolveName",r=>{let t;r.target.nodeType===1&&(t=r.target.getAttribute("data-mce-object"))&&(r.name=t)})})(a),(e=>{e.on("PreInit",()=>{const{schema:r,serializer:t,parser:s}=e,l=r.getBoolAttrs();x("webkitallowfullscreen mozallowfullscreen".split(" "),i=>{l[i]={}}),((i,m)=>{const o=ie(i);for(let c=0,d=o.length;c<d;c++){const n=o[c];m(i[n],n)}})({embed:["wmode"]},(i,m)=>{const o=r.getElementRule(m);o&&x(i,c=>{o.attributes[c]={},o.attributesOrder.push(c)})}),s.addNodeFilter("iframe,video,audio,object,embed,script",(i=>m=>{let o,c=m.length;for(;c--;)o=m[c],o.parent&&(o.parent.attr("data-mce-object")||(ke(o)&&ue(i)?te(o)||o.replace(Ae(i,o)):te(o)||o.replace(Oe(i,o))))})(e)),t.addAttributeFilter("data-mce-object",(i,m)=>{var o;let c=i.length;for(;c--;){const d=i[c];if(!d.parent)continue;const n=d.attr(m),u=new _(n,1);if(n!=="audio"&&n!=="script"){const v=d.attr("class");v&&v.indexOf("mce-preview-object")!==-1&&d.firstChild?u.attr({width:d.firstChild.attr("width"),height:d.firstChild.attr("height")}):u.attr({width:d.attr("width"),height:d.attr("height")})}u.attr({style:d.attr("style")});const h=(o=d.attributes)!==null&&o!==void 0?o:[];let p=h.length;for(;p--;){const v=h[p].name;v.indexOf("data-mce-p-")===0&&u.attr(v.substr(11),h[p].value)}n==="script"&&u.attr("type","text/javascript");const b=d.attr("data-mce-html");if(b){const v=Ce(e,n,unescape(b));x(v.children(),T=>u.append(T))}d.replace(u)}})}),e.on("SetContent",()=>{const r=e.dom;x(r.select("span.mce-preview-object"),t=>{r.select("span.mce-shim",t).length===0&&r.add(t,"span",{class:"mce-shim"})})})})(a),(e=>{e.on("click keyup touchend",()=>{const r=e.selection.getNode();r&&e.dom.hasClass(r,"mce-preview-object")&&e.dom.getAttrib(r,"data-mce-selected")&&r.setAttribute("data-mce-selected","2")}),e.on("ObjectSelected",r=>{r.target.getAttribute("data-mce-object")==="script"&&r.preventDefault()}),e.on("ObjectResized",r=>{const t=r.target;if(t.getAttribute("data-mce-object")){let s=t.getAttribute("data-mce-html");s&&(s=unescape(s),t.setAttribute("data-mce-html",escape(F(s,{width:String(r.width),height:String(r.height)},!1,e.schema))))}})})(a),(e=>({showDialog:()=>{X(e)}}))(a)))})();
