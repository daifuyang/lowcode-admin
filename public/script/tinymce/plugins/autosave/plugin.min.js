(function(){"use strict";var y=tinymce.util.Tools.resolve("tinymce.PluginManager");const D=t=>(e=>{const r=typeof e;return e===null?"null":r==="object"&&Array.isArray(e)?"array":r==="object"&&(o=a=e,(n=String).prototype.isPrototypeOf(o)||((m=a.constructor)===null||m===void 0?void 0:m.name)===n.name)?"string":r;var o,a,n,m})(t)==="string",h=t=>t===void 0;var _=tinymce.util.Tools.resolve("tinymce.util.Delay"),s=tinymce.util.Tools.resolve("tinymce.util.LocalStorage"),v=tinymce.util.Tools.resolve("tinymce.util.Tools");const I=t=>{const e=/^(\d+)([ms]?)$/.exec(t);return(e&&e[2]?{s:1e3,m:6e4}[e[2]]:1)*parseInt(t,10)},i=t=>e=>e.options.get(t),b=i("autosave_ask_before_unload"),w=i("autosave_restore_when_empty"),S=i("autosave_interval"),E=i("autosave_retention"),u=t=>{const e=document.location;return t.options.get("autosave_prefix").replace(/{path}/g,e.pathname).replace(/{query}/g,e.search).replace(/{hash}/g,e.hash).replace(/{id}/g,t.id)},f=(t,e)=>{if(h(e))return t.dom.isEmpty(t.getBody());{const r=v.trim(e);if(r==="")return!0;{const o=new DOMParser().parseFromString(r,"text/html");return t.dom.isEmpty(o)}}},l=t=>{var e;const r=parseInt((e=s.getItem(u(t)+"time"))!==null&&e!==void 0?e:"0",10)||0;return!(new Date().getTime()-r>E(t)&&(c(t,!1),1))},c=(t,e)=>{const r=u(t);s.removeItem(r+"draft"),s.removeItem(r+"time"),e!==!1&&(o=>{o.dispatch("RemoveDraft")})(t)},p=t=>{const e=u(t);!f(t)&&t.isDirty()&&(s.setItem(e+"draft",t.getContent({format:"raw",no_events:!0})),s.setItem(e+"time",new Date().getTime().toString()),(r=>{r.dispatch("StoreDraft")})(t))},d=t=>{var e;const r=u(t);l(t)&&(t.setContent((e=s.getItem(r+"draft"))!==null&&e!==void 0?e:"",{format:"raw"}),(o=>{o.dispatch("RestoreDraft")})(t))};var R=tinymce.util.Tools.resolve("tinymce.EditorManager");const g=t=>e=>{e.setEnabled(l(t));const r=()=>e.setEnabled(l(t));return t.on("StoreDraft RestoreDraft RemoveDraft",r),()=>t.off("StoreDraft RestoreDraft RemoveDraft",r)};y.add("autosave",t=>((e=>{const r=e.options.register,o=a=>{const n=D(a);return n?{value:I(a),valid:n}:{valid:!1,message:"Must be a string."}};r("autosave_ask_before_unload",{processor:"boolean",default:!0}),r("autosave_prefix",{processor:"string",default:"tinymce-autosave-{path}{query}{hash}-{id}-"}),r("autosave_restore_when_empty",{processor:"boolean",default:!1}),r("autosave_interval",{processor:o,default:"30s"}),r("autosave_retention",{processor:o,default:"20m"})})(t),(e=>{e.editorManager.on("BeforeUnload",r=>{let o;v.each(R.get(),a=>{a.plugins.autosave&&a.plugins.autosave.storeDraft(),!o&&a.isDirty()&&b(a)&&(o=a.translate("You have unsaved changes are you sure you want to navigate away?"))}),o&&(r.preventDefault(),r.returnValue=o)})})(t),(e=>{(o=>{const a=S(o);_.setEditorInterval(o,()=>{p(o)},a)})(e);const r=()=>{(o=>{o.undoManager.transact(()=>{d(o),c(o)}),o.focus()})(e)};e.ui.registry.addButton("restoredraft",{tooltip:"Restore last draft",icon:"restore-draft",onAction:r,onSetup:g(e)}),e.ui.registry.addMenuItem("restoredraft",{text:"Restore last draft",icon:"restore-draft",onAction:r,onSetup:g(e)})})(t),t.on("init",()=>{w(t)&&t.dom.isEmpty(t.getBody())&&d(t)}),(e=>({hasDraft:()=>l(e),storeDraft:()=>p(e),restoreDraft:()=>d(e),removeDraft:r=>c(e,r),isEmpty:r=>f(e,r)}))(t)))})();
